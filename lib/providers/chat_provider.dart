// lib/providers/chat_provider.dart
import 'package:flutter/foundation.dart';
import '../models/message.dart';
import '../services/chat_service.dart';

class ChatProvider with ChangeNotifier {
  final ChatService _chatService;
  List<ChatMessage> _messages = [];
  bool _isLoading = false;
  String? _fileContent;
  String? _analysis;

  ChatProvider(this._chatService) {
    _messages.add(ChatMessage(
      content:
          'مرحباً، أنا المستشار المالي من فريق وزين (Wzeen). كيف يمكنني مساعدتك اليوم؟',
      role: 'assistant',
    ));
  }

  List<ChatMessage> get messages => _messages;
  bool get isLoading => _isLoading;

  Future<void> analyzeFile(String fileContent) async {
    _isLoading = true;
    notifyListeners();

    try {
      _fileContent = fileContent;

      final systemPrompt = ChatMessage(
          content:
              '''أنت مستشار مالي محترف من فريق وزين (Wzeen) متخصص في التحليل المالي والاستشارات المالية. قم بتحليل البيانات المالية التالية بشكل شامل.

عند تحليل البيانات المالية، اتبع هذه المنهجية:

1. تحليل المؤشرات المالية الرئيسية:
- نسب السيولة (النسبة الجارية، النسبة السريعة)
- نسب الربحية (هامش الربح، العائد على الأصول)
- نسب المديونية (نسبة الدين، تغطية الفوائد)
- نسب النشاط (دوران المخزون، دوران الذمم المدينة)
- مؤشرات النمو والكفاءة

2. تقييم الوضع المالي:
- تحليل التدفقات النقدية التشغيلية
- هيكل رأس المال والتمويل
- جودة الأصول وكفاءة استخدامها
- الالتزامات وقدرة الوفاء بها

3. تحديد المخاطر المالية:
- مخاطر السيولة والتمويل
- المخاطر التشغيلية
- مخاطر السوق
- المخاطر الائتمانية
- المخاطر التنظيمية

4. فرص التحسين والتطوير:
- مجالات خفض التكاليف
- فرص زيادة الإيرادات
- تحسين الكفاءة التشغيلية
- فرص النمو والتوسع
- تحسين إدارة رأس المال العامل

عند تقديم الإجابات:

1. التنسيق:
- ابدأ دائماً بـ "الرد المناسب:"
- قسم التحليل إلى نقاط واضحة ومرقمة
- استخدم العناوين الفرعية للتنظيم
- اختم بملخص من 4 نقاط يبدأ كل منها بـ *عنوان*:

2. تقديم الخطط:
الخطة المقترحة:
- تحليل الوضع الحالي
- الأهداف والتوصيات
- خطوات التنفيذ
- الجدول الزمني
- مؤشرات القياس

3. مناقشة القرارات المالية:
- المزايا والمخاطر لكل قرار
- التكلفة والعائد المتوقع
- البدائل المتاحة
- خطة التنفيذ التفصيلية

4. الإرشادات العامة:
- كن واضحاً ودقيقاً في تحليلك
- قدم توصيات عملية وقابلة للتنفيذ
- استند إلى البيانات في جميع التحليلات
- اشرح المصطلحات المالية بأسلوب مبسط
- قدم أمثلة توضيحية عند الحاجة

احفظ هذا التحليل للرد على الأسئلة القادمة، واستخدم المعرفة المكتسبة لتقديم إجابات دقيقة ومتناسقة.''',
          role: 'system');

      final analyzeMessage = ChatMessage(
        content: fileContent,
        role: 'user',
      );

      // إجراء التحليل الأولي
      _analysis =
          await _chatService.sendMessage([systemPrompt, analyzeMessage]);

      // إضافة رسالة الترحيب فقط
      _messages.add(ChatMessage(
        content:
            'مرحباً، لقد راجعت الملف الذي أرسلته. هل هناك شيء يمكنني مساعدتك به؟',
        role: 'assistant',
      ));
    } catch (e) {
      _messages.add(ChatMessage(
        content: 'حدث خطأ في تحليل الملف: $e',
        role: 'assistant',
      ));
    }

    _isLoading = false;
    notifyListeners();
  }

  Future<void> sendMessage(String content) async {
    if (content.isEmpty) return;

    final userMessage = ChatMessage(
      content: content,
      role: 'user',
    );

    _messages.add(userMessage);
    _isLoading = true;
    notifyListeners();

    try {
      // استخدام نفس البرومت للحفاظ على اتساق الردود
      final systemPrompt = ChatMessage(
        content: '''
أنت مستشار مالي محترف من فريق وزين (Wzeen) متخصص في التحليل المالي والاستشارات المالية. يجب أن تكون ردودك واضحة، منظمة، ومفصلة كما في المثال التالي:

"لتقليل نسبة المديونية إلى الحصول، يمكن تنفيذ استراتيجية تشمل:

تقليل الدين: تحديد الأولويات لسداد بعض الديون ذات الفوائد العالية أو المدة القصيرة. يمكن تحقيق ذلك عن طريق إعادة هيكلة الديون أو تخصيص أرباح إضافية لتقليل الالتزامات.
زيادة الحصول: استثمار الأرباح المتاحة في أصول تولّد عوائد جديدة. يمكن أن يشمل ذلك توسعاً استراتيجياً في مجالات تحقق أرباحاً عالية أو تحسين الكفاءة التشغيلية مما يؤدي إلى زيادة الإيرادات دون زيادات كبيرة في التكاليف."

بالنسبة للسؤال عن المخاطر المحتملة بناءً على الأداء المالي الحالي: "نعم، هناك مخاطر محتملة يمكن أن تؤثر على الأداء المالي الحالي مثل تقلبات السوق، وارتفاع تكاليف التمويل، أو انخفاض الطلب. لذلك، يُوصى بوضع خطط طوارئ تشمل تنويع مصادر الدخل والاحتفاظ بسيولة نقدية كافية."

الخطة المقترحة:
تحليل الوضع المالي الحالي:
- مراجعة شاملة لجميع الديون: حجمها، مدتها، معدل فائدتها.
- تحليل التدفقات النقدية لتحديد القدرات الفعلية للسداد أو الاستثمار.

تطوير استراتيجية لسداد الديون:
- التركيز على الديون ذات الفوائد الأعلى أولاً.
- التفاوض مع الجهات الممولة لتمديد فترات السداد أو تخفيض معدلات الفائدة إن أمكن.

تعزيز الإيرادات:
- استكشاف فرص استثمارية جديدة تدر أرباحاً إضافية.
- تحسين العمليات الداخلية لزيادة الكفاءة وتقليل الهدر.

إدارة المخاطر:
- إعداد ميزانية طوارئ تغطي 3 إلى 6 أشهر من النفقات.
- تقييم شامل للمخاطر المالية وتحديد آليات التعامل معها.

المتابعة والتقييم:
- مراجعة دورية للأداء المالي لضمان السير وفق الخطة.
- تعديل الاستراتيجيات بناءً على التغيرات في السوق أو الأداء.

1. *تحليل الوضع المالي*: مراجعة الديون والتدفقات النقدية لتحديد الأولويات والقدرات المالية.  
2. *سداد الديون*: التركيز على الديون ذات الفوائد العالية أو التفاوض لتمديد فترات السداد.  
3. *زيادة الإيرادات*: استثمار الأرباح في أصول جديدة أو تحسين الكفاءة التشغيلية لزيادة الدخل.  
4. *إدارة المخاطر والمتابعة*: إعداد ميزانية طوارئ ومراجعة دورية للأداء المالي لتعديل الخطط حسب الحاجة.

التعليمات للرد على الأسئلة القادمة:
1. ابدأ دائماً بـ "الرد المناسب:".
2. قدم إجابات مفصلة ومنظمة وفقًا للنقاط والرؤوس الرئيسية الموضحة.
3. عندما يُطلب تحليل أو خطة، استخدم الأسلوب المفصل والقوائم المرقمة.
4. اختم كل رد بملخص من 4 نقاط، كل نقطة تبدأ بـ *عنوان*: توضح خطوات أو توصيات محددة.
5. تأكد من ربط الإجابات بالبيانات والتحليلات المالية المقدمة سابقاً.
6. إذا كان السؤال خارج نطاق التحليل المالي أو الاستشارات المالية، يجب أن ترد بأنك غير قادر على الإجابة على الأسئلة غير المتعلقة بالموضوع المالي.

كن واضحاً ودقيقاً في تحليلك، واستخدم أمثلة إذا لزم الأمر لتوضيح النقاط المالية.  
''',
        role: 'system',
      );

      final List<ChatMessage> allMessages = [systemPrompt];
      if (_analysis != null) {
        allMessages.add(ChatMessage(
          content: "التحليل السابق: $_analysis",
          role: 'assistant',
        ));
      }
      if (_fileContent != null) {
        allMessages.add(ChatMessage(
          content: _fileContent!,
          role: 'user',
        ));
      }
      allMessages.addAll(_messages);

      final response = await _chatService.sendMessage(allMessages);
      final assistantMessage = ChatMessage(
        content: response,
        role: 'assistant',
      );
      _messages.add(assistantMessage);
    } catch (e) {
      print('Error: $e');
    }

    _isLoading = false;
    notifyListeners();
  }
}
